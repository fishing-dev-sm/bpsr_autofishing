## 星痕共鸣自动钓鱼：流程与识别分析

本文档总结本项目（auto_fish）的自动钓鱼识别与决策步骤，便于理解与调参。

### 一、整体思路
- 基于窗口客户区截图（mss），在固定/缩放后的 ROI 内做颜色与模板匹配，驱动鼠标与键盘行为完成一轮钓鱼。
- 支持 16:9 多分辨率：所有坐标/尺寸均以 1920×1080 为基准，运行时通过 `get_scale_point`/`get_scale_area` 缩放。

### 二、运行入口与主循环
- 入口：`auto_fish/main.py`，通过 `find_window_by_process_name(PROCESS_NAME)` 锁定游戏窗口（默认 `Star.exe`）。
- 退出热键：按下 `Esc`/`~`/`Q`/`Ctrl` 任意一个即可安全退出。
- 主循环每轮步骤：
  1) 截图 `full_img`；先执行耐久检查与自动换竿。
  2) 甩钩：点击 `CLICK_POS`。
  3) 等待 `START_DELAY` 前的分段延迟，期间循环检测“鱼跑了”蓝绿色提示。
  4) 自动定位红点密集区域，作为鱼漂/拉扯监控区。
  5) 在该区域内判断“上钩”（红点消失且白色占比上升）后按住鼠标进入遛鱼。
  6) 遛鱼方向：基于水纹白色占比扫描，选择长按 `A` 或 `D`；跨区时互斥释放上一个方向键。
  7) 检测钓鱼完成（灰色区域颜色匹配）→ 释放鼠标 → 延迟 → 点击二次位置收尾 → 等待 → 开始下一轮。

### 三、视觉/判定策略
1) 鱼跑了（提前终止）
   - ROI：`BLUE_ROI`，颜色表：`BLUE_COLORS`，容差：`BLUE_TOLERANCE`。
   - 判定：ROI 平均色与某个目标蓝绿色的通道差均 ≤ 容差。
   - 时机：甩钩后到正式进入红点监控前，以及遛鱼循环中每帧。

2) 红点密集区域定位（鱼漂区）
   - 大搜索区：以 `RED_SEARCH_REGION_CENTER` 为中心，半径 `RED_SEARCH_REGION_OFFSET`；最多尝试 3 层（沿 Y 方向每层 +100px）。
   - 小窗口扫描：`RED_DETECT_BOX_SIZE` 边长，HSV 红色双区间，计算红色占比，取最大值 `(max_rect, max_ratio)`。
   - 判定阈值：`RED_THRESHOLD`（若低于仍继续，但会记录“找不到红点”日志）。

3) 上钩触发（按下鼠标）
   - 在 `red_rect` ROI 内同时判断：
     - `is_red_dominant(roi) == False`（红比例低）
     - `is_white_dominant(roi) == True`（白比例高，默认 > 0.2）
   - 满足条件即认为上钩，按下鼠标左键并保持（进入遛鱼阶段）。

4) 遛鱼方向判定（A/D）—新版红橙色检测
   - 判定区域：
     - A 区域：以 `(794, 540)` 为中心，`20×20` 方框（随分辨率缩放）。
     - D 区域：以 `(1124, 540)` 为中心，`20×20` 方框（随分辨率缩放）。
   - 颜色规则：复用上钩 HSV 判定，扩展包含橙色段 `H∈[10,25]`；当 ROI 内红/橙像素占比 ≥ 阈值（默认 `0.10`）时视为触发。
   - 决策（锁定-切换）：
     - A 触发后：持续按 `A`，直到 D 触发才切换到 `D`；A 触发消失不会松开。
     - D 触发后：持续按 `D`，直到 A 触发才切换到 `A`；D 触发消失不会松开。
     - 同时触发：保持当前方向；若无当前方向，则不按。
   - 日志：记录 A/D 触发（边沿）以及 A/D 的按下/释放事件。

5) 钓鱼完成判定
   - 区域：`COLOR_CHECK_AREA`，目标色：`TARGET_COLOR`（RGB），颜色均值匹配（通道差 ≤ 容差）。
   - 动作：释放鼠标 → 关闭蓝色检查 → 等待 `AFTER_DETECT_CLICK_DELAY` → 点击 `SECOND_CLICK_POS` → 等待 `AFTER_SECOND_CLICK_DELAY` → 结束本轮。

### 四、自动换竿流程
- 开始每轮前调用 `check_and_replace_rod`：
  - 在右下角 ROI（比例 `roi_scale=(0.75,0.75)`）做模板匹配 `assets/add_rod.png`。
  - 匹配分数 ≥ 0.9 认为“鱼竿没耐久”。
  - 执行动作：
    1) 按键 `ROD_NO_DURABILITY_KEY`；
    2) 点击 `ROD_CHANGE_CLICK_POS`；
    3) 点击 `ROD_CONFIRM_CLICK_POS`；
    各步骤间隔 `ROD_NO_DURABILITY_DELAY` 秒。

### 五、关键配置（`auto_fish/config.py`）
- 进程名：`PROCESS_NAME`（默认 `Star.exe`）
- 甩钩/收尾：`CLICK_POS`、`SECOND_CLICK_POS`、`START_DELAY`、`AFTER_SECOND_CLICK_DELAY`、`AFTER_DETECT_CLICK_DELAY`
- 红点与鱼漂区：`RED_SEARCH_REGION_CENTER`、`RED_SEARCH_REGION_OFFSET`、`RED_DETECT_BOX_SIZE`、`RED_THRESHOLD`
- 鱼跑了提示：`BLUE_ROI`、`BLUE_COLORS`、`BLUE_TOLERANCE`
- 完成判定：`COLOR_CHECK_AREA`、`TARGET_COLOR`
- 换竿：`ROD_NO_DURABILITY_KEY`、`ROD_CHANGE_CLICK_POS`、`ROD_CONFIRM_CLICK_POS`、`ROD_NO_DURABILITY_DELAY`

提示：若你使用的分辨率/UI缩放不同，可只改中心/区域坐标，无需改代码；程序会按基准分辨率做等比缩放。

### 六、运行与依赖
- 平台：Windows（使用 `win32gui`、`ctypes.windll`、`pygetwindow` 等）。
- 依赖：见 `auto_fish/requirements.txt`；推荐创建虚拟环境安装。
- 运行：
  1) 启动游戏、进入钓鱼界面；
  2) 运行 `python auto_fish/main.py`；
  3) 脚本自动切换到目标窗口并开始循环；
  4) 退出：按 `Esc`/`~`/`Q`/`Ctrl`。

### 七、调参建议
- 红点难以稳定识别：增大 `RED_SEARCH_REGION_OFFSET`、略调 `RED_THRESHOLD` 或 `RED_DETECT_BOX_SIZE`。
- 误判鱼跑了：适当增大 `BLUE_TOLERANCE` 或微调 `BLUE_ROI`。
- 遛鱼左右抖动：增大“中心无方向区间”阈值（代码中 ±200px），或调大 `find_best_water_region` 的 `step`。
- 完成判定不触发：微调 `COLOR_CHECK_AREA` 及 `TARGET_COLOR`。
- 换竿过早/过晚：调整模板图或分数阈值（`0.9`）。

### 八、文件与关键函数对照
- 主流程：`main.py` → `monitor_window`
- 截图与窗口：`window_util.py` → `capture_window`、`click_mouse_window`、缩放函数
- 颜色/模板：`color_util.py` → 红色/白色/蓝绿色判定与红点搜索
- 遛鱼水纹：`window_util.py` → `find_best_water_region`
- 自动换竿：`game_logic.py` → `check_and_replace_rod`

如需进一步定制逻辑，建议从上述函数入手逐步调整。


